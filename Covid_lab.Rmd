---
title: "Lab: Covid-19 + Census Data"
output: 
  learnr::tutorial:
  progressive: true
  allow_skip: false
runtime: shiny_prerendered
---

```{r setup, include = FALSE}
if(!require(learnr)) {
  install.packages("learnr")
}
library(learnr)

if(!require(dplyr)) {
  install.packages("dplyr")
}
library(dplyr)

if(!require(rgdal)) {
  install.packages("openintro")
}
library(rgdal)

if(!require(viridis)) {
  install.packages("openintro")
}
library(viridis)

if(!require(shiny)) {
  install.packages("shiny")
}
library(shiny)

if(!require(tidyr)) {
  install.packages("tidyr")
}
library(tidyr)

borough <- read.csv("data/data_summ_bor.csv")
zcta <- read.csv("data/data_summ_zcta.csv")
NYC_zips <- readOGR("Shape_Files/ZIP_CODE_040114.shp")

knitr::opts_chunk$set(echo = FALSE)
```  
  
```{r load_data}

```
  
## The Data: A summary 
In this lab, you will inspect and interact with some data that has been compiled for you. The datasets loaded here were compiled using census data, COVID19 data (downloaded from github), and shape files for NYC zip codes (for plotting). You can see how this data was downloaded and merged by watching this week's accompanying videos. There are three files loaded for you in this space: data by zip code (called "zcta"), data by borough (called "borough"), and a shape file for plotting maps of nyc zip codes (called "NYC_zips").  



## Inspecting the data  

### Exercise: Print the first few rows

Use the `head()` function or square brackets to inspect the first 5 rows of the `borough` and `zcta` datasets. 
```{r inspect_data, exercise=TRUE, exercise.setup = 'load-data'}

```

```{r inspect_data-solution}
head(borough, 5)
head(zcta, 5)
#or:
borough[1:5,]
zcta[1:5,]
```
   
```{r 5row-quiz}
quiz(
  question("What is the median income in the Bronx?",
    answer("36381"),
    answer("59620"),
    answer("46586"),
    answer("27074", correct = TRUE)
  )
)

```  

### Exercise: Inspect the structure of the data    

Try using the `str()` function below to look at the structure of each dataset.  

```{r structure, exercise=TRUE, exercise.setup = 'load-data'}

```

```{r structure-solution}
str(borough)
str(zcta)
```
     
At this point, it might be useful to also inspect some of the variables more carefully to make sure we understand what they are. For now, let's focus on the zip-code level data. Looking at the data structure, we note that the second three variables are called "Positive," "Total," and "zcta_cum.perc_pos". "Positive" gives the number of positive tests by zipcode, "Total" gives the number of total tests by zipcode, and now we will show below that zcta_cum.perc_pos is just the percentage of total tests that were positive (i.e., Positive/Total*100, rounded to two decimals):    
```{r postotal, exercise=TRUE, exercise.setup = 'load-data'}
head(round(zcta$Positive/zcta$Total*100,2))
head(zcta$zcta_cum.perc_pos)
```
  
Another useful gut check: the census data includes a "total" variable for most demographic variables. In this dataset, we have collected the reported values for "Race_Total".. But is this the same as the full population? Initially, we collected both variables because it was important to check whether the two values are equivalent. It was possible that race information wasn't collected for the entire population and that the total number of people included in the race counts could be different from the full population. However, upon further inspection, these variables actually have the same values:   
```{r pop, exercise=TRUE, exercise.setup = 'load-data'}
head(zcta$Race_Total)
head(zcta$Population)
```
  
That said, you might notice that there is another variable called TotalPop. This variable was imported as part of the group of variables related to education level. Note that the values in this column are different from the Race_Total and Population columns. Looking at the documentation provided by the Census, it turns out this is because education level is only recorded for people over the age of 25.  
```{r pop2, exercise=TRUE, exercise.setup = 'load-data'}
head(zcta$Population)
head(zcta$TotalPop)
```

## 1 and 2-way Tables: Race/Income  
First, let's make a one way table of race, where race is defined as low, medium, and high proportion white (notice that case rates are higher in zip codes with a relatively low proportion of white people, and lower in zip codes with a relatively high proportion of white people). Activity: Run the provided code. Then see if you can change it so that there are only 2 categories for the White_Prop variable.    
```{r oneway_race, exercise=TRUE, exercise.setup = 'load-data'}
propwhite <- zcta %>% 
  mutate(White_Prop = round((White_Total)/Race_Total), 2) %>%
  mutate(White_Prop_Lev = ntile(White_Prop, 3)) %>%
  group_by(White_Prop_Lev) %>%
  summarise(Cases_per_1000 = round(sum(Positive)/sum(Population)*1000, 2)) 
propwhite <- propwhite[-nrow(propwhite),]
propwhite
```

```{r oneway_race-solution}
propwhite <- zcta %>% 
  mutate(White_Prop = round((White_Total)/Race_Total), 2) %>%
  mutate(White_Prop_Lev = ntile(White_Prop, 2)) %>%
  group_by(White_Prop_Lev) %>%
  summarise(Cases_per_1000 = round(sum(Positive)/sum(Population)*1000, 2)) 
propwhite <- propwhite[-nrow(propwhite),]
propwhite
```  
  
One way table of income, where income is defined as low income, medium income, and high income. (Notice that case rates are higher in zip codes with a relatively low median income, and lower in zip codes with a relatively high median income):  
```{r oneway_inc, exercise=TRUE, exercise.setup = 'load-data'}
inc <- zcta %>% 
  mutate(Med_Inc_Lev = ntile(Med_Income, 3)) %>%
  group_by(Med_Inc_Lev) %>%
  summarise(Cases_per_1000 = round(sum(Positive)/sum(Population)*1000, 2))
inc <- inc[-nrow(inc),]
inc
```
  

Let's try to reproduce a 2-way table of race and income. We notice something kind of interesting. It seems like case rates don't vary as much by income among zip codes with a low proportion of white people. Meanwhile, case rates vary a lot more by income among zip codes with a high proportion of white people.    
```{r twoway, exercise=TRUE, exercise.setup = 'load-data'}
inc_propwhite <- zcta %>% 
  mutate(White_Prop = round((White_Total)/Race_Total), 2) %>%
  mutate(White_Prop_Lev = ntile(White_Prop, 3)) %>%
  mutate(Med_Inc_Lev = ntile(Med_Income, 3)) %>%
  group_by(White_Prop_Lev, Med_Inc_Lev) %>%
  summarise(Cases_per_1000 = round(sum(Positive)/sum(Population)*1000, 2)) %>%
  spread(White_Prop_Lev, Cases_per_1000, fill=0)
inc_propwhite <- inc_propwhite[-nrow(inc_propwhite),-ncol(inc_propwhite)]
inc_propwhite[,1] <- c("Low Income", "Med Income", "High Income")
colnames(inc_propwhite) <- c(NA, "Low Prop White", "Med Prop White", "High Prop White")
inc_propwhite
```

```{r twoway-solution}

```
  
For a moment, let's come back to the one-way table of the proportion of the population that is white. Here is another way we could have constructed that one-way table for race (this version is really a two-way table of race and case rate). The code below does the following: First, we divide the zip codes into two equally sized groups based on the proportion of the population that is white (half the zip codes are classified as having a high proportion of white people, half are classified as having a low proportion of white people). Then, we do the same thing by case rate (half the zip codes are classified as having a high case rate and half are classified as having a low case rate). Finally, we construct a 2-way table of these new categorical variables, where the values in the table are counts of zip codes. For example, there are 38 zip codes that are classified as having a low case rate AND a low proportion of white people.     
```{r oneway_race2, exercise=TRUE, exercise.setup = 'load-data'}
propwhite2 <- zcta %>% 
  mutate(White_Prop = round((White_Total)/Race_Total), 2) %>%
  mutate(White_Prop_Lev = ntile(White_Prop, 2)) %>%
  mutate(Cases_per_1000 = round(Positive/Population*1000, 2)) %>%
  mutate(CaseRate_Lev = ntile(Cases_per_1000, 2)) %>%
  group_by(White_Prop_Lev, CaseRate_Lev) %>%
  summarise(N_Zips = n()) %>%
  spread(White_Prop_Lev, N_Zips, fill=0)
propwhite2 <- propwhite2[-3,-4]
propwhite2[,1] <- c("Low Case Rate", "High Case Rate")
colnames(propwhite2) <- c(NA, "Low Prop White", "High Prop White")
propwhite2
```
  
We observe something that may or may not be surprising: There are more zip codes with a high proportion of white people and low case rate or low proportion of white people and high case rate (as compared to the other two categories). This suggests that zip codes with a higher proportion of non-white residents tend to have higher case rates. Can we test whether these differences are meaningful?   
Let's start with the value in the "low proportion white, high case rate category" (which is 57). We'll create a fake dataset that looks like the observed data (it would produce the same table as above), but then we will randomly reassign the levels of "proportion white" 1000 times, each time storing the number of zip codes in the low-white/high-case category. Then we can plot a histogram of the simulated values (with a vertical line at our observed value of 57). We can also calculate the proportion of simulated values greater than 57. See if you can follow the code below:    
```{r sim, exercise=TRUE, exercise.setup = 'load-data'}
numzips <- 38+57+57+37
num_low_white <- num_low_case <- 38+57
num_high_white <- num_high_case <- 57+37

simdata <- data.frame(CaseRate_Lev = c(rep(1, num_low_case), rep(2, num_high_case)),
                      White_Prop_Lev = c(rep(1, num_low_white), rep(2, num_high_white)))
set.seed(333)
simvals <- vector()
for(i in 1:1000){
  simdata$White_Prop_Lev <- sample(simdata$White_Prop_Lev)
  simvals[i] <- table(simdata)[2,1]
}

hist(simvals)
abline(v=57, lwd=2, col="blue")

#proportion of simulated values greater than 57
sum(simvals>=57)/1000
```
  
We note that only about 0.4% of our simulated values were greater than 57. It's therefore possible, but very unlikely that we would have observed this large of a value by random chance (if the truth was that there was no relationship between the proportion of the population that is white and the case rate). However, this cannot tell us WHY this relationship exists.   
  
## Scatter Plots: Race/Income   
We can get a different, finer grain look at some of these relationships by looking at scatter plots. To start, we plot a scatter plot of the positive case rate as a function of the proportion of the population that is white.  
```{r scatter1, exercise=TRUE, exercise.setup = 'load-data'}
plot(zcta$White_Total/zcta$Population*100,
     round(zcta$Positive/zcta$Population*1000,1), 
     xlab="percent white", 
     ylab="pos cases per 1000 ppl", 
     pch=16)
```
  
Next, we do the same for positive case rate vs. income:  
```{r scatter2, exercise=TRUE, exercise.setup = 'load-data'}
plot(zcta$Med_Income,
     round(zcta$Positive/zcta$Population*1000,1), 
     xlab="median income", 
     ylab="pos cases per 1000 ppl", 
     pch=16)
```
  
And finally, percent white vs. median income:  
```{r scatter3, exercise=TRUE, exercise.setup = 'load-data'}
plot(zcta$Med_Income,
     zcta$White_Total/zcta$Population*100, 
     xlab="median income", 
     ylab="pos cases per 1000 ppl", 
     pch=16)
```  
   
   
